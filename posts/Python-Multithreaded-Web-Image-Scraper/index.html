<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.7.2"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Python Multithreaded Web Image Scraper" /><meta property="og:locale" content="en_US" /><meta name="description" content="Who is this post for ?" /><meta property="og:description" content="Who is this post for ?" /><link rel="canonical" href="/posts/Python-Multithreaded-Web-Image-Scraper/" /><meta property="og:url" content="/posts/Python-Multithreaded-Web-Image-Scraper/" /><meta property="og:site_name" content="Think Nibbles" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-02-02T01:35:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Python Multithreaded Web Image Scraper" /> <script type="application/ld+json"> {"mainEntityOfPage":{"@type":"WebPage","@id":"/posts/Python-Multithreaded-Web-Image-Scraper/"},"description":"Who is this post for ?","url":"/posts/Python-Multithreaded-Web-Image-Scraper/","@type":"BlogPosting","headline":"Python Multithreaded Web Image Scraper","dateModified":"2021-02-02T01:35:00+08:00","datePublished":"2021-02-02T01:35:00+08:00","@context":"https://schema.org"}</script><title>Python Multithreaded Web Image Scraper | Think Nibbles</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" href="/assets/css/post.css" as="style"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-MCRJSPWTZV"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-MCRJSPWTZV'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/avatar/full-size.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Think Nibbles</a></div><div class="site-subtitle font-italic">keep calm and continue nibbling</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tabs/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tabs/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/tabs/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/tabs/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['',''].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Python Multithreaded Web Image Scraper</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Python Multithreaded Web Image Scraper</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Tue, Feb 2, 2021, 1:35 AM +0800" > Feb 2 <i class="unloaded">2021-02-02T01:35:00+08:00</i> </span> by <span class="author"> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="994 words">5 min</span></div></div><div class="post-content"><h3 id="who-is-this-post-for-">Who is this post for ?</h3><p>Software developers / machine learning engineers / data scients looking for a python script to automate downloading of images from the web.</p><h3 id="tools-this-post-will-be-using-">Tools this post will be using :</h3><ol><li>Python 3<li>Chrome driver<li>MacOS (Catalina)</ol><h3 id="lets-start-">Let’s start :</h3><p>Data is not always readily available in a form in which it can be consumed. Good data even less so. Data scientists are all too aware of this issue. In recent years, especially due to the growth in the field of data science, data gathering has become an important part of the lives of data scientists the world over. This post is written with the aim of helping others save time when it comes to downloading images from the web.</p><h3 id="source-code-">Source Code :</h3><p>If you like, the source code for this entire post is available <a href="https://github.com/SonalKiran/PyImageScraper">here</a> and can be downloaded for free.</p><p>This script is divided into three parts -</p><ol><li><p>A function to fetch URLs: This function takes the following arguments -</p><ol><li>Keyword for which images are to be downloaded<li>Number of URLs to be fetched for that keyword</ol><p>Given the above arguments, this function then saves the keyword and its URLs in a dictionary named ‘master_urls’.</p><li><p>A function to fetch images: This function takes the following arguments -</p><ol><li>Request.session() object which allows the persistence of parameters across requests<li>URL from which to download image<li>Filename under which to store the downloaded image</ol><p>Given the above arguments, this function then attempts to download the image and save it under the given filename. If instead, we have the base64 of the image, it converts and saves that base64 as an image.</p><li><p>The main function which employs multithreading to speed up the entire process: It is here that all the heavy lifting is done.</p><ol><li>We first read the keywords from the ‘queries.csv’ and save them in the ‘keywords’ list.<li>Since fetching URLs from a webpage is an IO-bound task (most of the time is spent waiting on input-output operations), multithreading helps to significantly reduce the time taken by this activity. We use concurrent.futures module’s <a href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.ThreadPoolExecutor"><code class="language-plaintext highlighter-rouge">ThreadPoolExecutor</code></a> for this. Please refer to the linked documentation if you wish to understand how this executor works. All the keyword-URL pairs are stored in the ‘master_urls’ dictionary.<li>We then save this dictionary as ‘keyword_urls.txt’ in case we ever need to reference it later. To load this dictionary from a text file, the required code has been provided, although it has been commented out since we won’t be requiring it now.<li>Having curated a list of URLs for each keyword, we then pass this list on to the ‘fetch_img’ function. Again, since this is mostly an IO-bound task, we employ multithreading to speed things up. Images for each keyword are stored under a folder by the same name inside the ‘images’ folder in the root folder.</ol></ol><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
</pre><td class="rouge-code"><pre><span class="c1"># imports
</span><span class="kn">from</span> <span class="nn">selenium</span> <span class="kn">import</span> <span class="n">webdriver</span>
<span class="kn">import</span> <span class="nn">time</span><span class="p">,</span> <span class="n">requests</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">concurrent.futures</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">from</span> <span class="nn">selenium.common.exceptions</span> <span class="kn">import</span> <span class="n">WebDriverException</span>
<span class="kn">from</span> <span class="nn">selenium.common.exceptions</span> <span class="kn">import</span> <span class="n">TimeoutException</span>

<span class="c1"># function to fetch urls
</span><span class="k">def</span> <span class="nf">fetch_url</span><span class="p">(</span><span class="n">search_query</span><span class="p">,</span> <span class="n">url_count</span> <span class="o">=</span> <span class="mi">20</span><span class="p">):</span>
    <span class="n">browser</span> <span class="o">=</span> <span class="n">webdriver</span><span class="p">.</span><span class="n">Chrome</span><span class="p">()</span>
    <span class="n">search_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"https://www.google.com/search?site=&amp;tbm=isch&amp;source=hp&amp;biw=1873&amp;bih=990&amp;q=</span><span class="si">{</span><span class="n">search_query</span><span class="si">}</span><span class="s">"</span>
    <span class="n">images_url</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># open browser and begin search
</span>    <span class="n">browser</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">search_url</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">elements</span> <span class="o">=</span> <span class="n">browser</span><span class="p">.</span><span class="n">find_elements_by_class_name</span><span class="p">(</span><span class="s">'rg_i'</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">TimeoutException</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Loading took too much time!"</span><span class="p">)</span>

    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">:</span>
        <span class="c1"># fetch image urls
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">e</span><span class="p">.</span><span class="n">click</span><span class="p">()</span>
            <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.5</span><span class="p">)</span>
            <span class="n">element</span> <span class="o">=</span> <span class="n">browser</span><span class="p">.</span><span class="n">find_elements_by_class_name</span><span class="p">(</span><span class="s">'v4dQwb'</span><span class="p">)</span>
            <span class="c1"># Google Chrome logic
</span>            <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">big_img</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">find_element_by_class_name</span><span class="p">(</span><span class="s">'n3VNCb'</span><span class="p">)</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">big_img</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">find_element_by_class_name</span><span class="p">(</span><span class="s">'n3VNCb'</span><span class="p">)</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">images_url</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">big_img</span><span class="p">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s">"src"</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">WebDriverException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Web Driver Exception Occurred: </span><span class="si">{</span><span class="n">e</span><span class="p">.</span><span class="n">__str__</span><span class="p">()</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># save urls for the given search query in a dictionary
</span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">images_url</span><span class="p">)</span> <span class="o">==</span> <span class="n">url_count</span><span class="p">:</span>
            <span class="k">global</span> <span class="n">master_urls</span>
            <span class="n">master_urls</span><span class="p">[</span><span class="n">search_query</span><span class="p">]</span> <span class="o">=</span> <span class="n">images_url</span>
            <span class="n">browser</span><span class="p">.</span><span class="n">quit</span><span class="p">()</span>
            <span class="k">break</span>

<span class="c1"># function to fetch images
</span><span class="k">def</span> <span class="nf">fetch_img</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="k">if</span> <span class="s">'base64'</span> <span class="ow">in</span> <span class="n">url</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">b64</span> <span class="o">=</span> <span class="n">url</span><span class="p">[</span><span class="n">url</span><span class="p">.</span><span class="n">index</span><span class="p">(</span><span class="s">'base64'</span><span class="p">)</span><span class="o">+</span><span class="mi">6</span><span class="p">:]</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">base64</span><span class="p">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">b64</span><span class="p">))</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Base64 to Image - Exception Occurred: </span><span class="si">{</span><span class="n">e</span><span class="p">.</span><span class="n">__str__</span><span class="p">()</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">sess</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">stream</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">r</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="c1"># Open a local file with wb ( write binary ) permission.
</span>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">r</span><span class="p">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">128</span><span class="p">):</span>
                        <span class="n">fd</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'Image successfully downloaded: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'Unable to downloaded image: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Exception Occurred: </span><span class="si">{</span><span class="n">e</span><span class="p">.</span><span class="n">__str__</span><span class="p">()</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="c1"># retrieve master_urls dict from keyword_urls.txt
# with open('./keyword_urls.txt', 'r') as file:
#     new_dict = file.read()
# master_urls = ast.literal_eval(new_dict)
</span>
<span class="c1"># define the path of csv containing keywords
</span><span class="n">csv_path</span> <span class="o">=</span> <span class="s">'./queries.csv'</span>

<span class="c1"># set destination directory to store images
</span><span class="n">dest_dir</span> <span class="o">=</span> <span class="s">'./images'</span>

<span class="c1"># initialize dict
</span><span class="n">master_urls</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># load search queries from csv
</span>    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="n">data</span><span class="p">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s">"Query"</span><span class="p">]</span>

    <span class="c1"># save queries to a list
</span>    <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s">"Query"</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))]</span>

    <span class="c1"># fetch urls using multithreading and save to master_urls dict
</span>    <span class="k">with</span> <span class="n">concurrent</span><span class="p">.</span><span class="n">futures</span><span class="p">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="k">as</span> <span class="k">exec</span><span class="p">:</span>
        <span class="n">future</span> <span class="o">=</span> <span class="p">[</span><span class="k">exec</span><span class="p">.</span><span class="n">submit</span><span class="p">(</span><span class="n">fetch_url</span><span class="p">,</span> <span class="n">search_query</span><span class="o">=</span><span class="n">val</span><span class="p">,</span> <span class="n">url_count</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="k">for</span>
                  <span class="n">val</span> <span class="ow">in</span> <span class="n">keywords</span><span class="p">]</span>

    <span class="c1">#  ensure dest_dir exists
</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="p">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">)</span>

    <span class="c1"># save master_urls in text file for future reference
</span>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">,</span><span class="s">'keyword_urls.txt'</span><span class="p">),</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
        <span class="nb">file</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">master_urls</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">master_urls</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># create directory for every keyword for which image is to be downloaded
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">,</span> <span class="n">key</span><span class="p">)):</span>
            <span class="n">os</span><span class="p">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
        <span class="c1"># download images
</span>        <span class="k">with</span> <span class="n">requests</span><span class="p">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">concurrent</span><span class="p">.</span><span class="n">futures</span><span class="p">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="k">as</span> <span class="k">exec</span><span class="p">:</span>
                <span class="n">future</span> <span class="o">=</span> <span class="p">[</span><span class="k">exec</span><span class="p">.</span><span class="n">submit</span><span class="p">(</span><span class="n">fetch_img</span><span class="p">,</span> <span class="n">sess</span><span class="o">=</span><span class="n">sess</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">val</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">'.jpg'</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                    <span class="n">values</span><span class="p">)]</span>

<span class="n">main</span><span class="p">()</span>
</pre></table></code></div></div><p><strong>I hope this post was helpful.</strong></p><p><strong>Cheers!</strong></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/python/'>Python</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/python/" class="post-tag no-text-decoration" >Python</a> <a href="/tags/imagescraper/" class="post-tag no-text-decoration" >ImageScraper</a> <a href="/tags/multithreading/" class="post-tag no-text-decoration" >Multithreading</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Python Multithreaded Web Image Scraper - Think Nibbles&url=/posts/Python-Multithreaded-Web-Image-Scraper/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Python Multithreaded Web Image Scraper - Think Nibbles&u=/posts/Python-Multithreaded-Web-Image-Scraper/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Python Multithreaded Web Image Scraper - Think Nibbles&url=/posts/Python-Multithreaded-Web-Image-Scraper/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/welcome-to-jekyll/">Create your first Hello World iOS App</a><li><a href="/posts/pytorch-java-intellij-maven-macos/">Use PyTorch machine learning framework in Java using Intellij and maven on MacOS</a><li><a href="/posts/securing-application-properties/">Securing application properties with jasypt spring boot maven java intellij macos</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/backenddevelopment/">BackendDevelopment</a> <a class="post-tag" href="/tags/intellij/">Intellij</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/macos/">macOS</a> <a class="post-tag" href="/tags/pytorch/">pytorch</a> <a class="post-tag" href="/tags/springboot/">SpringBoot</a> <a class="post-tag" href="/tags/bytedeco/">bytedeco</a> <a class="post-tag" href="/tags/computer-vision/">Computer Vision</a> <a class="post-tag" href="/tags/encryption/">Encryption</a> <a class="post-tag" href="/tags/imagescraper/">ImageScraper</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/tesseract-ocr-java-intellij/"><div class="card-body"> <span class="timeago small" > Mar 28 <i class="unloaded">2021-03-28T01:35:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Guide to start using bytedeco Opencv</h3><div class="text-muted small"><p> Who is this post for ? Backend Java developers looking to start using bytedeco OpenCV libraries. Tools this post will be using : JavaCV ( bytedeco ) - 1.5.5 Oracle Java 1.8 Intellij Mav...</p></div></div></a></div><div class="card"> <a href="/posts/securing-application-properties/"><div class="card-body"> <span class="timeago small" > Dec 15, 2020 <i class="unloaded">2020-12-15T01:35:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Securing application properties with jasypt spring boot maven java intellij macos</h3><div class="text-muted small"><p> Who is this post for ? Backend software developers working towards making their code production ready or anyone looking to conceal property source files. Tools this post will be using : Jasyp...</p></div></div></a></div><div class="card"> <a href="/posts/pytorch-java-intellij-maven-macos/"><div class="card-body"> <span class="timeago small" > Dec 9, 2020 <i class="unloaded">2020-12-09T01:35:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Use PyTorch machine learning framework in Java using Intellij and maven on MacOS</h3><div class="text-muted small"><p> Who is this post for ? Software developers / machine learning engineers / data scients looking to get a pytorch model loaded into their java program. Tools this post will be using : PyTorch ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/securing-application-properties/" class="btn btn-outline-primary"><p>Securing application properties with jasypt spring boot maven java intellij macos</p></a> <a href="/posts/tesseract-ocr-java-intellij/" class="btn btn-outline-primary"><p>Guide to start using bytedeco Opencv</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href=""></a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/backenddevelopment/">BackendDevelopment</a> <a class="post-tag" href="/tags/intellij/">Intellij</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/macos/">macOS</a> <a class="post-tag" href="/tags/pytorch/">pytorch</a> <a class="post-tag" href="/tags/springboot/">SpringBoot</a> <a class="post-tag" href="/tags/bytedeco/">bytedeco</a> <a class="post-tag" href="/tags/computer-vision/">Computer Vision</a> <a class="post-tag" href="/tags/encryption/">Encryption</a> <a class="post-tag" href="/tags/imagescraper/">ImageScraper</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
